<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rádio Online</title>
    <style>
        :root {
    --primary-color: #4f46e5;
    --primary-hover: #6366f1;
    --primary-light: #1e1b4b;
    --secondary-color: #e2e8f0;
    --accent-color: #f43f5e;
    --text-color: #e2e8f0;
    --text-light: #94a3b8;
    --light-bg: #0f172a;
    --card-bg: #1e293b;
    --border-color: #334155;
    --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
    --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.25);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.35);
    --radius-sm: 6px;
    --radius-md: 8px;
    --radius-lg: 12px;
    --radius-full: 9999px;
    --transition: 200ms cubic-bezier(0.4, 0, 0.2, 1);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
}

body {
    background-color: var(--light-bg);
    color: var(--text-color);
    line-height: 1.6;
    font-size: 16px;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

header {
    background-color: #1e1b4b;
    background-image: linear-gradient(135deg, #1e1b4b, #4338ca);
    color: white;
    padding: 1.25rem 2rem;
    box-shadow: var(--shadow-md);
    position: sticky;
    top: 0;
    z-index: 100;
}

.container {
    max-width: 1280px;
    margin: 0 auto;
    padding: 1.5rem;
}

.search-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    gap: 1rem;
    background-color: var(--card-bg);
    padding: 1.25rem;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
}

.search-box {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    position: relative;
}

input, select, button {
    padding: 0.875rem 1.25rem;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-color);
    font-size: 1rem;
    transition: all var(--transition);
    outline: none;
}

input {
    flex: 1;
    min-width: 200px;
    box-shadow: var(--shadow-sm);
    background-color: #0f172a;
    color: var(--text-color);
}

input:focus, select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
}

button {
    background-color: var(--primary-color);
    color: white;
    border: none;
    cursor: pointer;
    transition: background-color var(--transition), transform var(--transition);
    white-space: nowrap;
    font-weight: 500;
    box-shadow: var(--shadow-sm);
}

button:hover {
    background-color: var(--primary-hover);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

button:active {
    transform: translateY(0);
}

.filter-container {
    display: flex;
    gap: 1.25rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    background-color: var(--card-bg);
    padding: 1.25rem;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
}

.filter-group {
    flex: 1;
    min-width: 200px;
}

.filter-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: var(--text-light);
    font-size: 0.875rem;
}

select {
    width: 100%;
    background-color: #0f172a;
    color: var(--text-color);
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    background-size: 1.25rem;
    padding-right: 2.5rem;
}

.radio-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1.5rem;
}

.radio-card {
    background-color: var(--card-bg);
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: var(--shadow-md);
    transition: transform var(--transition), box-shadow var(--transition);
    position: relative;
    border: 1px solid var(--border-color);
}

.radio-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg);
}

.radio-image {
    height: 180px;
    background-color: #0f172a;
    background-image: linear-gradient(45deg, #0f172a, #1e293b);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 3rem;
    overflow: hidden;
    position: relative;
}

.radio-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--transition);
}

.radio-card:hover .radio-image img {
    transform: scale(1.05);
}

.radio-info {
    padding: 1.25rem;
}

.radio-name {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: var(--secondary-color);
}

.radio-details {
    font-size: 0.9rem;
    color: var(--text-light);
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
}

.radio-details span {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.75rem;
}

.tag {
    background-color: var(--primary-light);
    color: #a5b4fc;
    padding: 0.25rem 0.625rem;
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    font-weight: 500;
}

.play-button {
    position: absolute;
    bottom: 1.25rem;
    right: 1.25rem;
    width: 48px;
    height: 48px;
    border-radius: var(--radius-full);
    background-color: var(--primary-color);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: var(--shadow-md);
    transition: all var(--transition);
}

.play-button:hover {
    background-color: var(--primary-hover);
    transform: scale(1.1);
}

.play-button svg {
    width: 24px;
    height: 24px;
    fill: white;
}

.player-container {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background-color: #0f172a;
    color: white;
    padding: 1rem 1.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    z-index: 100;
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
}

.player-container.active {
    transform: translateY(0);
}

.now-playing {
    display: flex;
    align-items: center;
    gap: 1.25rem;
}

.station-logo {
    width: 60px;
    height: 60px;
    background-color: var(--primary-color);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

.station-logo img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.station-info {
    flex: 1;
}

.station-info h3 {
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.station-info p {
    color: #94a3b8;
    font-size: 0.875rem;
}

.player-controls {
    display: flex;
    align-items: center;
    gap: 1.5rem;
}

.control-button {
    background-color: rgba(255, 255, 255, 0.1);
    color: white;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    width: 40px;
    height: 40px;
    border-radius: var(--radius-full);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition);
}

.control-button:hover {
    background-color: rgba(255, 255, 255, 0.2);
    transform: scale(1.1);
}

.control-button.play-pause {
    width: 48px;
    height: 48px;
    background-color: var(--primary-color);
}

.control-button.play-pause:hover {
    background-color: var(--primary-hover);
}

.volume-control {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    background-color: rgba(255, 255, 255, 0.1);
    padding: 0.5rem 1rem;
    border-radius: var(--radius-full);
}

.volume-slider {
    width: 100px;
    appearance: none;
    height: 4px;
    border-radius: var(--radius-full);
    background-color: rgba(255, 255, 255, 0.2);
    outline: none;
}

.volume-slider::-webkit-slider-thumb {
    appearance: none;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: white;
    cursor: pointer;
}

.loading {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 300px;
    flex-direction: column;
    gap: 1rem;
}

.spinner {
    width: 60px; /* Aumentar tamanho */
    height: 60px; /* Aumentar tamanho */
    border-radius: 50%;
    background-color: var(--primary-color); /* Cor primária como fundo */
    animation: pulse 1.5s ease-in-out infinite; /* Nova animação */
    /* border e border-top-color removidos */
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

@keyframes pulse { /* Nova animação */
    0% {
        transform: scale(0.8);
        opacity: 0.7;
    }
    50% {
        transform: scale(1);
        opacity: 1;
    }
    100% {
        transform: scale(0.8);
        opacity: 0.7;
    }
}

.loading p {
    color: var(--text-light);
    font-weight: 500;
}

.no-results {
    text-align: center;
    padding: 3rem;
    color: var(--text-light);
    background-color: var(--card-bg);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
}

.no-results svg {
    width: 64px;
    height: 64px;
    margin-bottom: 1rem;
    color: var(--text-light);
    opacity: 0.5;
}

.no-results h3 {
    font-size: 1.25rem;
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.pagination {
    display: flex;
    justify-content: center;
    margin-top: 2.5rem;
    gap: 0.5rem;
}

.pagination button {
    padding: 0.625rem 1rem;
    min-width: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 500;
}

.pagination button.active {
    background-color: #0f172a;
    color: white;
}

.pagination button:disabled {
    background-color: #334155;
    color: #64748b;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

@media (max-width: 768px) {
    .search-container, .filter-container {
        flex-direction: column;
        padding: 1rem;
    }
    
    .radio-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    }
    
    .player-container {
        flex-direction: column;
        gap: 1.25rem;
        padding: 1.25rem 1rem;
    }
    
    .station-info {
        text-align: center;
        margin-bottom: 0.5rem;
    }
    
    .now-playing {
        flex-direction: column;
        width: 100%;
    }
    
    .player-controls {
        width: 100%;
        justify-content: center;
    }
    
    .volume-control {
        margin-top: 0.5rem;
    }
}
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Rádio Online</h1>
        </div>
    </header>

    <main class="container">
        <div id="general-error-message" style="display: none; padding: 1rem; margin-bottom: 1rem; background-color: var(--accent-color); color: white; border-radius: var(--radius-md); text-align: center;"></div>
        <div class="search-container">
            <div class="search-box">
                <input type="text" id="search-input" placeholder="Pesquisar estações...">
                <button id="search-button">Pesquisar</button>
            </div>
            <div>
                <button id="favorites-button">Favoritos</button>
            </div>
        </div>

    <div class="filter-container">
    <div class="filter-group">
        <label for="country-filter">País:</label>
        <select id="country-filter">
            <option value="">Todos os Países</option>
        </select>
    </div>
    <div class="filter-group">
        <label for="language-filter">Idioma:</label>
        <select id="language-filter">
            <option value="">Todos os Idiomas</option>
        </select>
    </div>
    <div class="filter-group">
        <label for="tag-filter">Gênero:</label>
        <select id="tag-filter">
            <option value="">Todos os Gêneros</option>
        </select>
    </div>

            <div class="filter-group">
                <label for="sort-options">Ordenar por:</label>
                <select id="sort-options">
                    <option value="name">Nome (A-Z)</option>
                    <option value="votes">Mais Votadas</option>
                    <option value="clicks">Mais Populares</option>
                    <option value="bitrate">Melhor Qualidade</option>
                </select>
            </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Buscando estações, por favor aguarde...</p>
        </div>

        <div id="radio-grid" class="radio-grid"></div>

        <div id="pagination" class="pagination"></div>
        </main>

    <div id="player" class="player-container">
        <div class="now-playing">
            <div class="station-logo">
                <i class="radio-icon">📻</i>
            </div>
            <div class="station-info">
                <h3 id="current-station">Nome da Estação</h3>
                <p id="current-info">País - Gênero</p>
            </div>
        </div>
        <div class="player-controls">
            <button class="control-button" id="stop-button">⏹️</button>
            <button class="control-button play-pause" id="play-pause-button">▶️</button>
            <div class="volume-control">
                <span>🔊</span>
                <input type="range" id="volume" min="0" max="1" step="0.1" value="0.7">
            </div>
        </div>
        <audio id="audio-player"></audio>
    </div>

    <script>
        const API_BASE_URL = 'https://de1.api.radio-browser.info/json';
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const favoritesButton = document.getElementById('favorites-button');
        const countryFilter = document.getElementById('country-filter');
        const languageFilter = document.getElementById('language-filter');
        const tagFilter = document.getElementById('tag-filter');
        const sortOptions = document.getElementById('sort-options');
        const radioGrid = document.getElementById('radio-grid');
        const loading = document.getElementById('loading');
        const pagination = document.getElementById('pagination');
        const player = document.getElementById('player');
        const audioPlayer = document.getElementById('audio-player');
        const currentStation = document.getElementById('current-station');
        const currentInfo = document.getElementById('current-info');
        const stopButton = document.getElementById('stop-button');
        const volumeControl = document.getElementById('volume');
        const playPauseButton = document.getElementById('play-pause-button');
        const playerErrorMessage = document.getElementById('player-error-message');
        const tryNextStationButton = document.getElementById('try-next-station-button');


        let currentPage = 1;
        let itemsPerPage = 20;
        let totalStations = 0;
        let favorites = JSON.parse(localStorage.getItem('favorites')) || [];
        let showingFavorites = false;
        let stations = []; // Array global para armazenar as estações
        let currentStationIndex = 0; //Índice da estação atual

        const filters = {
            name: '',
            country: '',
            language: '',
            tagList: '', // Inicializado como vazio
            order: 'name',
            reverse: false,
            offset: 0,
            limit: itemsPerPage,
            hidebroken: true
        };


        async function fetchData(endpoint, params = {}) {
            try {
                const url = new URL(`${API_BASE_URL}${endpoint}`);
                Object.entries(params).forEach(([key, value]) => {
                    if (value !== undefined && value !== null && value !== '') {
                        url.searchParams.append(key, value);
                    }
                });

                const response = await fetch(url, {
                    headers: {
                        'User-Agent': 'RadioOnlineWebApp/1.0'
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    const message = `Erro na requisição da API (${response.status}): ${errorText}`;
                    throw new Error(message);
                }

                return await response.json();
            } catch (error) {
                // console.error('Erro ao buscar dados:', error); // Removido pois handleError fará o log.
                handleError(error); 
                return [];
            }
        }

        function handleError(error) {
            console.error('Erro detectado:', error); // Mantém o log no console

            const generalErrorMessage = document.getElementById('general-error-message');

            if (generalErrorMessage) {
                // Limitar o tamanho da mensagem para não quebrar o layout
                const displayMessage = error.message.length > 150 ? error.message.substring(0, 147) + "..." : error.message;
                generalErrorMessage.textContent = `Erro: ${displayMessage}`;
                generalErrorMessage.style.display = 'block';

                // Opcional: ocultar a mensagem após alguns segundos
                setTimeout(() => {
                    generalErrorMessage.style.display = 'none';
                }, 7000); // Oculta após 7 segundos
            } else {
                // Fallback se o elemento não existir (embora não devesse acontecer)
                // Este alert só será usado se o #general-error-message não for encontrado.
                alert(`Erro: ${error.message}`);
            }
        }

        async function loadFilters() {
            try {
                const [countries, languages, tags] = await Promise.all([
                    fetchData('/countries'),
                    fetchData('/languages'),
                    fetchData('/tags')
                ]);

                populateSelect(countryFilter, countries, 'name');
                populateSelect(languageFilter, languages, 'name');
                populateSelect(tagFilter, tags.filter(tag => tag.name.trim() !== '' && tag.stationcount > 5).sort((a, b) => b.stationcount - a.stationcount).slice(0, 50), 'name');
                //tagFilter.multiple = true;

            } catch (error) {
                handleError(error);
            }
        }

        function populateSelect(selectElement, data, valueProperty) {
            selectElement.innerHTML = '';
            const firstOption = document.createElement('option');
            firstOption.value = '';
            firstOption.textContent = 'Todos';
            selectElement.appendChild(firstOption);

            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item[valueProperty];
                option.textContent = item[valueProperty] + (item.stationcount ? ` (${item.stationcount})` : '');
                selectElement.appendChild(option);
            });
        }


        async function searchStations() {
            showLoading(true);
            radioGrid.innerHTML = '';

            if (showingFavorites) {
                displayFavorites();
                return;
            }

            try {
                // Create countFilters from the global filters object
                const countFilters = {
                    name: filters.name,
                    country: filters.country,
                    language: filters.language,
                    tagList: filters.tagList,
                    hidebroken: filters.hidebroken !== undefined ? filters.hidebroken : true
                };
                const countResponse = await fetchData('/stations/search/count', countFilters);
                totalStations = parseInt(countResponse.value, 10);
                const stationsData = await fetchData('/stations/search', filters);
                stations = stationsData; // This populates the global 'stations' array
                // currentStationIndex = 0; // This is already here from a previous change, as expected by the task.

                if (stations.length === 0) {
                    showNoResultsMessage('Nenhuma estação encontrada', 'Tente palavras-chave diferentes ou ajuste os filtros de país, idioma ou gênero.');
                } else {
                    displayStations(stations);
                    updatePagination();
                }
            } catch (error) {
                showNoResultsMessage('Erro ao buscar estações', 'Houve um problema ao carregar as estações. Por favor, tente novamente mais tarde ou recarregue a página.');
            } finally {
                showLoading(false);
            }
        }

        function showNoResultsMessage(title, suggestion) {
            radioGrid.innerHTML = `
                <div class="no-results">
                    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search" style="color: var(--text-light); margin-bottom: 1rem; opacity: 0.7;">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <h3>${title}</h3>
                    <p style="color: var(--text-light);">${suggestion}</p>
                </div>
            `;
        }


        function displayStations(stations) {
            radioGrid.innerHTML = '';
            stations.forEach(station => {
                const card = createStationCard(station);
                radioGrid.appendChild(card);
            });
        }


        function displayFavorites() {
            radioGrid.innerHTML = '';
            showLoading(true);

            if (favorites.length === 0) {
                showNoResultsMessage('Você ainda não tem estações favoritas', 'Clique no ícone de coração ❤️ em uma estação para adicioná-la aqui!');
                showLoading(false);
                return;
            }

            fetchFavoriteStations();
        }


        async function fetchFavoriteStations() {
            currentStationIndex = 0; // Resetar o índice
            stations = []; // Limpar o array de estações global
            try {
                const favoriteStationsData = await fetchData('/stations/byuuid', { uuids: favorites.join(',') });
                stations = favoriteStationsData; // ATRIBUIR AO ARRAY GLOBAL 'stations'
                displayStations(stations); 
            } catch (error) {
                showNoResultsMessage('Erro ao buscar seus favoritos', 'Houve um problema ao carregar suas estações favoritas. Por favor, tente recarregar a página.');
                stations = []; // Limpar em caso de erro também
            } finally {
                showLoading(false);
            }
        }


        function createStationCard(station) {
            const card = document.createElement('div');
            card.className = 'radio-card';

            const isFavorite = favorites.includes(station.stationuuid);
            const favoriteClass = isFavorite ? 'favorite active' : 'favorite';
            const favoriteIcon = isFavorite ? '❤️' : '🤍';

            const tags = station.tags ? station.tags.split(',').slice(0, 3).map(tag => `<span class="tag">${tag.trim()}</span>`).join('') : '';

            card.innerHTML = `
                <div class="radio-image">
                    ${station.favicon ? `<img src="${station.favicon}" alt="${station.name}" onerror="this.onerror=null; this.src='https://via.placeholder.com/100/1e293b/e2e8f0?text=Radio';">` : '📻'}
                </div>
                <div class="radio-info">
                    <h3 class="radio-name">${station.name}</h3>
                    <div class="radio-details">
                        <span>${station.country || 'País Desconhecido'}</span>
                        <span>${station.language || 'Idioma Desconhecido'}</span>
                        <div class="tags">${tags}</div>
                    </div>
                    <button class="${favoriteClass}" data-uuid="${station.stationuuid}">${favoriteIcon}</button>
                </div>
                <div class="play-button" data-url="${station.url_resolved || station.url}" data-name="${station.name}" data-info="${station.country} - ${station.tags?.split(',')[0] || 'Sem gênero'}" data-stationuuid="${station.stationuuid}">▶️</div>
            `;

            const playButton = card.querySelector('.play-button');
            playButton.addEventListener('click', () => {
                playStation(playButton.dataset.url, playButton.dataset.name, playButton.dataset.info, playButton.dataset.stationuuid);
            });

            const favoriteButton = card.querySelector('.favorite');
            favoriteButton.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleFavorite(station.stationuuid, favoriteButton);
            });

            return card;
        }


        function playStation(url, name, info, stationuuid) {
    playerErrorMessage.style.display = 'none';
    tryNextStationButton.style.display = 'none';

    audioPlayer.src = url;
    audioPlayer.volume = volumeControl.value;
    audioPlayer.onended = playNextStation; // For sequential play when a stream ends naturally

    audioPlayer.play()
        .then(() => {
            currentStation.textContent = name;
            currentInfo.textContent = info;
            player.classList.add('active');
            playPauseButton.textContent = '⏸️'; // Playback started successfully
            trackStationClick(stationuuid);
            // Ensure error UI is hidden, might be redundant if onplaying fires reliably but good for safety
            playerErrorMessage.style.display = 'none';
            tryNextStationButton.style.display = 'none';
        })
        .catch(error => {
            // This catch handles initial loading/setup errors before playback attempts.
            console.error(`Error attempting to play ${name} (${stationuuid}):`, error);
            // Manually trigger the visual error handling as if audioPlayer.onerror fired.
            const stationNameForError = name || "A estação";
            playerErrorMessage.textContent = `Erro ao carregar "${stationNameForError}".`;
            playerErrorMessage.style.display = 'block';
            tryNextStationButton.style.display = 'block';
            playPauseButton.textContent = '▶️'; // Set to play as it failed to start
        });
}

        playPauseButton.addEventListener('click', () => {
            if (audioPlayer.paused) {
                audioPlayer.play();
                playPauseButton.textContent = '⏸️';
            } else {
                audioPlayer.pause();
                playPauseButton.textContent = '▶️';
            }
        });

        async function trackStationClick(stationuuid) {
        if (!stationuuid) {
            console.error('stationuuid não fornecido para trackStationClick');
            return;
        }
        try {
            await fetch(`${API_BASE_URL}/url/${stationuuid}`, {
                method: 'GET', 
                headers: {
                    'User-Agent': 'RadioOnlineWebApp/1.1 (Tracking)'
                }
            });
        } catch (error) {
            console.error('Erro ao registrar clique:', error);
        }
    }


        function toggleFavorite(uuid, button) {
            const index = favorites.indexOf(uuid);

            if (index === -1) {
                favorites.push(uuid);
                button.textContent = '❤️';
                button.classList.add('active');
            } else {
                favorites.splice(index, 1);
                button.textContent = '🤍';
                button.classList.remove('active');

                if (showingFavorites) {
                    const card = button.closest('.radio-card');
                    card.remove();

                    if (favorites.length === 0) {
                        displayFavorites();
                    }
                }
            }

            localStorage.setItem('favorites', JSON.stringify(favorites));
        }


        function updatePagination() {
            const totalPages = Math.ceil(totalStations / itemsPerPage);
            pagination.innerHTML = '';

            if (totalPages <= 1) return;

            const prevBtn = createPaginationButton('« Anterior', () => {
                if (currentPage > 1) {
                    currentPage--;
                    updateFilters();
                    searchStations();
                }
            });
            prevBtn.disabled = currentPage === 1;

            const nextBtn = createPaginationButton('Próximo »', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    updateFilters();
                    searchStations();
                }
            });
            nextBtn.disabled = currentPage === totalPages;

            pagination.appendChild(prevBtn);

            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, startPage + 4);

            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = createPaginationButton(i, () => {
                    currentPage = i;
                    updateFilters();
                    searchStations();
                });
                pageBtn.classList.toggle('active', i === currentPage);
                pagination.appendChild(pageBtn);
            }

            pagination.appendChild(nextBtn);
        }


        function createPaginationButton(text, onClick) {
            const button = document.createElement('button');
            button.textContent = text;
            button.addEventListener('click', onClick);
            return button;
        }


        function updateFilters() {
            const tags = tagFilter.selectedOptions.length > 0 ? Array.from(tagFilter.selectedOptions).map(option => option.value).join(',') : '';

            filters.name = searchInput.value;
            filters.country = countryFilter.value;
            filters.language = languageFilter.value;
            filters.tagList = tags; // Atualiza tagList com as tags selecionadas
            filters.order = sortOptions.value;
            filters.reverse = sortOptions.value === 'votes' || sortOptions.value === 'clicks' || sortOptions.value === 'bitrate';
            filters.offset = (currentPage - 1) * itemsPerPage;
            filters.limit = itemsPerPage;
            filters.hidebroken = true;
        }


        function showLoading(show) {
            loading.style.display = show ? 'flex' : 'none';
        }


        searchButton.addEventListener('click', () => {
            currentPage = 1;
            updateFilters();
            searchStations();
        });

        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                currentPage = 1;
                updateFilters();
                searchStations();
            }
        });


        favoritesButton.addEventListener('click', () => {
            showingFavorites = !showingFavorites;
            favoritesButton.textContent = showingFavorites ? 'Todas as Estações' : 'Favoritos';
            currentPage = 1; // Reset currentPage - This is correct as per instructions.

            if (showingFavorites) {
                displayFavorites();
                pagination.style.display = 'none'; // Correctly hides pagination for favorites.
            } else {
                updateFilters(); 
                searchStations();
                pagination.style.display = 'flex'; // Correctly shows pagination for all stations.
            }
        });


        [countryFilter, languageFilter, tagFilter, sortOptions].forEach(filter => {
            filter.addEventListener('change', () => {
                if (!showingFavorites) {
                    currentPage = 1;
                    updateFilters();
                    searchStations();
                }
            });
        });


        stopButton.addEventListener('click', () => {
            audioPlayer.pause();
            audioPlayer.src = '';
            player.classList.remove('active');
            playPauseButton.textContent = '▶️'; //Resetar o botão play/pause
            playerErrorMessage.style.display = 'none'; // Hide error on stop
            tryNextStationButton.style.display = 'none'; // Hide button on stop
        });


        volumeControl.addEventListener('input', () => {
            audioPlayer.volume = volumeControl.value;
            localStorage.setItem('radioPlayerVolume', volumeControl.value);
        });

        // Old audioPlayer.onerror that called handleError will be removed.
        // The new one will be defined below.

    // New audioPlayer event handlers
    audioPlayer.onplaying = () => {
        playerErrorMessage.style.display = 'none';
        tryNextStationButton.style.display = 'none';
        playPauseButton.textContent = '⏸️'; // Playback is active
    };

    audioPlayer.onerror = () => {
        const stationName = currentStation.textContent || "A estação atual";
        playerErrorMessage.textContent = `Erro ao reproduzir "${stationName}". Tente a próxima.`;
        playerErrorMessage.style.display = 'block';
        tryNextStationButton.style.display = 'block';
        playPauseButton.textContent = '▶️'; // Indicate that it's not playing
        // Do not call playNextStation() automatically here.
    };

    // Event listener for the new button
    tryNextStationButton.addEventListener('click', () => {
        playerErrorMessage.style.display = 'none';
        tryNextStationButton.style.display = 'none';
        playNextStation();
    });

        window.addEventListener('load', () => {
            const savedVolume = localStorage.getItem('radioPlayerVolume');
            if (savedVolume !== null) {
                volumeControl.value = savedVolume;
                if (audioPlayer) { // audioPlayer is available globally
                    audioPlayer.volume = savedVolume;
                }
            } else {
                // Optional: Save the default volume if nothing is stored
                // The default value of volumeControl (0.7) is already set in HTML.
                // We just need to ensure audioPlayer also has it and store it.
                if (audioPlayer) {
                     audioPlayer.volume = volumeControl.value; // Apply default to audio player
                }
                localStorage.setItem('radioPlayerVolume', volumeControl.value);
            }

            loadFilters();
            updateFilters();
            searchStations();
        });


        async function playNextStation() {
            if (stations && stations.length > currentStationIndex + 1) {
                currentStationIndex++;
                const nextStation = stations[currentStationIndex];
                // Ensure stationuuid is passed to playStation
                playStation(nextStation.url_resolved || nextStation.url, nextStation.name, `${nextStation.country} - ${nextStation.tags?.split(',')[0] || 'Sem gênero'}`, nextStation.stationuuid);
            } else {
                const totalPages = Math.ceil(totalStations / itemsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    updateFilters();
                    await searchStations(); 
                    if (stations && stations.length > 0 && stations[0]) {
                        // Ensure stationuuid is passed to playStation
                        playStation(stations[0].url_resolved || stations[0].url, stations[0].name, `${stations[0].country} - ${stations[0].tags?.split(',')[0] || 'Sem gênero'}`, stations[0].stationuuid);
                    } else {
                        // This case might happen if the next page has no playable stations or API returns empty
                        playerErrorMessage.textContent = 'Fim de todas as estações ou nenhuma encontrada na próxima página.';
                        playerErrorMessage.style.display = 'block';
                        tryNextStationButton.style.display = 'none'; // No next station to try from here
                        player.classList.remove('active');
                        playPauseButton.textContent = '▶️';
                        currentStationIndex = 0; 
                    }
                } else {
                    playerErrorMessage.textContent = 'Fim de todas as estações.';
                    playerErrorMessage.style.display = 'block';
                    tryNextStationButton.style.display = 'none'; // No next station to try
                    player.classList.remove('active');
                    playPauseButton.textContent = '▶️';
                    currentStationIndex = 0;
                }
            }
        }
    </script>
</body>
</html>
